<?php
use Kumbia\Core\Security;
?>

<div class="container-fluid">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fa fa-user-tag text-primary"></i> <?= $title ?>
        </h1>
        <div>
            <a href="<?= PUBLIC_PATH ?>admin/roles" class="btn btn-outline-secondary">
                <i class="fa fa-arrow-left"></i> Volver
            </a>
            <?php if (AuthMiddleware::hasPermission('roles', 'edit')): ?>
                <a href="<?= PUBLIC_PATH ?>admin/roles/editar/<?= $rol[0]->id ?>" class="btn btn-outline-primary ms-2">
                    <i class="fa fa-edit"></i> Editar
                </a>
            <?php endif; ?>
        </div>
    </div>

    <div class="row">
        <!-- Información del Rol -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información del Rol</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <th width="30%">ID:</th>
                                <td><code>#<?= $rol[0]->id ?></code></td>
                            </tr>
                            <tr>
                                <th>Código:</th>
                                <td>
                                    <span class="badge bg-info"><?= h($rol[0]->codigo) ?></span>
                                </td>
                            </tr>
                            <tr>
                                <th>Nombre:</th>
                                <td><strong><?= h($rol[0]->nombre) ?></strong></td>
                            </tr>
                            <tr>
                                <th>Descripción:</th>
                                <td><?= h($rol[0]->descripcion) ?: '<span class="text-muted">Sin descripción</span>' ?></td>
                            </tr>
                            <tr>
                                <th>Nivel:</th>
                                <td>
                                    <span class="badge bg-<?= $rol[0]->nivel >= 100 ? 'danger' : ($rol[0]->nivel >= 50 ? 'warning' : 'info') ?>">
                                        Nivel <?= $rol[0]->nivel ?>
                                    </span>
                                    <small class="text-muted ms-2">
                                        (Mayor nivel = más privilegios)
                                    </small>
                                </td>
                            </tr>
                            <tr>
                                <th>Estado:</th>
                                <td>
                                    <?php if ($rol[0]->activo): ?>
                                        <span class="badge bg-success">
                                            <i class="fa fa-check"></i> Activo
                                        </span>
                                    <?php else: ?>
                                        <span class="badge bg-danger">
                                            <i class="fa fa-times"></i> Inactivo
                                        </span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                            <tr>
                                <th>Fecha creación:</th>
                                <td>
                                    <i class="fa fa-calendar-plus text-muted"></i>
                                    <?= $rol[0]->created_at ? date('d/m/Y H:i', strtotime($rol[0]->created_at)) : 'N/A' ?>
                                </td>
                            </tr>
                            <tr>
                                <th>Última actualización:</th>
                                <td>
                                    <i class="fa fa-calendar-check text-muted"></i>
                                    <?= $rol[0]->updated_at ? date('d/m/Y H:i', strtotime($rol[0]->updated_at)) : 'N/A' ?>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Permisos Asignados -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <span>Permisos Asignados</span>
                        <small><?= count($permisos) ?> permiso(s)</small>
                    </h5>
                </div>
                <div class="card-body">
                    <?php if (empty($permisos)): ?>
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i>
                            Este rol no tiene permisos asignados.
                        </div>
                    <?php else: ?>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th width="40%">Permiso</th>
                                        <th>Módulo</th>
                                        <th>Categoría</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php 
                                    $permisos_agrupados = [];
                                    foreach ($permisos as $permiso) {
                                        $modulo = $permiso->modulo ?: 'General';
                                        if (!isset($permisos_agrupados[$modulo])) {
                                            $permisos_agrupados[$modulo] = [];
                                        }
                                        $permisos_agrupados[$modulo][] = $permiso;
                                    }
                                    ?>
                                    
                                    <?php foreach ($permisos_agrupados as $modulo => $permisos_mod): ?>
                                        <tr class="table-light">
                                            <td colspan="4" class="fw-bold">
                                                <i class="fa fa-folder-open text-muted"></i>
                                                <?= h($modulo) ?>
                                                <span class="badge bg-secondary ms-2">
                                                    <?= count($permisos_mod) ?>
                                                </span>
                                            </td>
                                        </tr>
                                        <?php foreach ($permisos_mod as $permiso): ?>
                                            <tr>
                                                <td>
                                                    <span class="badge bg-primary">
                                                        <?= h($permiso->codigo) ?>
                                                    </span>
                                                    <br>
                                                    <small><?= h($permiso->nombre) ?></small>
                                                </td>
                                                <td><?= h($permiso->modulo) ?></td>
                                                <td>
                                                    <?php if ($permiso->categoria): ?>
                                                        <span class="badge bg-light text-dark">
                                                            <?= h($permiso->categoria) ?>
                                                        </span>
                                                    <?php endif; ?>
                                                </td>
                                                <td class="small text-muted">
                                                    <?= h($permiso->descripcion) ?>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Resumen de permisos -->
                        <div class="alert alert-light mt-3">
                            <h6 class="alert-heading">Resumen de permisos:</h6>
                            <?php
                            $total_permisos = count($permisos);
                            $modulos_count = count(array_unique(array_column((array)$permisos, 'modulo')));
                            $categorias_count = count(array_unique(array_column((array)$permisos, 'categoria')));
                            ?>
                            <p class="mb-0">
                                <i class="fa fa-cubes text-primary"></i>
                                <strong><?= $total_permisos ?></strong> permisos en 
                                <strong><?= $modulos_count ?></strong> módulo(s) y 
                                <strong><?= $categorias_count ?></strong> categoría(s)
                            </p>
                        </div>
                    <?php endif; ?>
                    
                    <?php if (AuthMiddleware::hasPermission('roles', 'assign_permissions')): ?>
                        <div class="text-center mt-3">
                            <a href="<?= PUBLIC_PATH ?>admin/roles/permisos/<?= $rol[0]->id ?>" 
                               class="btn btn-outline-info">
                                <i class="fa fa-key"></i> Gestionar Permisos
                            </a>
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- Columna lateral: Usuarios y Acciones -->
        <div class="col-md-4">
            <!-- Usuarios con este rol -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <span>Usuarios Asignados</span>
                        <span class="badge bg-light text-dark"><?= count($usuarios) ?></span>
                    </h5>
                </div>
                <div class="card-body">
                    <?php if (empty($usuarios)): ?>
                        <div class="text-center text-muted py-3">
                            <i class="fa fa-users fa-2x mb-3"></i>
                            <p>No hay usuarios asignados</p>
                        </div>
                    <?php else: ?>
                        <div class="list-group list-group-flush">
                            <?php foreach ($usuarios as $usuario): ?>
                                <a href="<?= PUBLIC_PATH ?>admin/usuarios/ver/<?= $usuario->id ?>" 
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">
                                            <i class="fa fa-user"></i>
                                            <?= h($usuario->nombre) ?>
                                        </h6>
                                        <small class="text-muted">
                                            <?= $usuario->activo ? 
                                                '<span class="badge bg-success">Activo</span>' : 
                                                '<span class="badge bg-danger">Inactivo</span>' ?>
                                        </small>
                                    </div>
                                    <p class="mb-1 small text-muted">
                                        <i class="fa fa-id-card"></i> <?= h($usuario->codigo) ?>
                                        <?php if ($usuario->email): ?>
                                            <br><i class="fa fa-envelope"></i> <?= h($usuario->email) ?>
                                        <?php endif; ?>
                                    </p>
                                    <small>
                                        <i class="fa fa-calendar"></i>
                                        <?= $usuario->created_at ? date('d/m/Y', strtotime($usuario->created_at)) : '' ?>
                                    </small>
                                </a>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                    
                    <div class="mt-3">
                        <a href="<?= PUBLIC_PATH ?>admin/usuarios?rol=<?= $rol[0]->id ?>" 
                           class="btn btn-outline-success w-100">
                            <i class="fa fa-search"></i> Ver todos los usuarios
                        </a>
                    </div>
                </div>
            </div>

            <!-- Estadísticas y Acciones -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Estadísticas</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="display-6 text-primary"><?= count($usuarios) ?></div>
                            <p class="small text-muted mb-0">Usuarios</p>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="display-6 text-info"><?= count($permisos) ?></div>
                            <p class="small text-muted mb-0">Permisos</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-light small">
                        <i class="fa fa-info-circle"></i>
                        <strong>Nota:</strong> Este rol tiene nivel <strong><?= $rol[0]->nivel ?></strong>.
                        <?php if ($rol[0]->nivel >= 90): ?>
                            <br><span class="text-danger">Es un rol administrativo.</span>
                        <?php endif; ?>
                    </div>
                </div>
            </div>

            <!-- Acciones Peligrosas -->
            <?php if (AuthMiddleware::hasPermission('roles', 'delete')): ?>
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fa fa-exclamation-triangle"></i> Acciones Peligrosas
                        </h5>
                    </div>
                    <div class="card-body">
                        <?php if (count($usuarios) > 0): ?>
                            <div class="alert alert-warning">
                                <i class="fa fa-users"></i>
                                <strong>No se puede eliminar:</strong>
                                Este rol tiene <?= count($usuarios) ?> usuario(s) asignado(s).
                            </div>
                        <?php else: ?>
                            <form action="<?= PUBLIC_PATH ?>roles/eliminar/<?= $rol[0]->id ?>" 
                                  method="post" 
                                  onsubmit="return confirm('¿Está SEGURO de eliminar este rol?\n\nEsta acción no se puede deshacer.')">
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="fa fa-trash"></i> Eliminar Rol
                                </button>
                                <small class="text-muted d-block mt-2">
                                    Solo se puede eliminar si no tiene usuarios asignados.
                                </small>
                            </form>
                        <?php endif; ?>
                        
                        <!-- Duplicar rol -->
                        <?php if (AuthMiddleware::hasPermission('roles', 'create')): ?>
                            <form action="<?= PUBLIC_PATH ?>roles/duplicar/<?= $rol[0]->id ?>" 
                                  method="post" 
                                  class="mt-3">
                                <button type="submit" class="btn btn-outline-secondary w-100">
                                    <i class="fa fa-copy"></i> Duplicar Rol
                                </button>
                                <small class="text-muted d-block mt-1">
                                    Crea una copia con los mismos permisos.
                                </small>
                            </form>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endif; ?>
        </div>
    </div>

    <!-- Historial de actividad reciente -->
    <?php if (!empty($actividad)): ?>
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Actividad Reciente</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Acción</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($actividad as $log): ?>
                        <tr>
                            <td nowrap>
                                <small><?= date('d/m/Y H:i', strtotime($log->fecha)) ?></small>
                            </td>
                            <td>
                                <?php if ($log->usuarios_id): ?>
                                    <i class="fa fa-user"></i> 
                                    <?= h($log->usuario_nombre ?? 'Usuario #' . $log->usuarios_id) ?>
                                <?php else: ?>
                                    <span class="text-muted">Sistema</span>
                                <?php endif; ?>
                            </td>
                            <td>
                                <span class="badge bg-info">
                                    <?= ucfirst(str_replace('_', ' ', $log->accion)) ?>
                                </span>
                            </td>
                            <td class="small">
                                <?php 
                                if ($log->detalles) {
                                    $detalles = json_decode($log->detalles, true);
                                    if (is_array($detalles)) {
                                        echo implode(', ', array_map(function($k, $v) {
                                            return "$k: $v";
                                        }, array_keys($detalles), $detalles));
                                    } else {
                                        echo h($log->detalles);
                                    }
                                }
                                ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <?php endif; ?>
</div>
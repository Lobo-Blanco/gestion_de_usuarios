<?php if (!isset($rol)): ?>
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Rol no encontrado
    </div>
    <a href="<?= PUBLIC_PATH ?>roles" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Volver a Roles
    </a>
<?php else: ?>
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-edit text-primary"></i> Editar Rol: <?= h($rol->nombre) ?>
        </h1>
        <div>
            <a href="<?= PUBLIC_PATH ?>roles/ver/<?= $rol->id ?>" class="btn btn-outline-info">
                <i class="fas fa-eye"></i> Ver
            </a>
            <a href="<?= PUBLIC_PATH ?>roles" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Estadísticas rápidas -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center py-3">
                            <h5 class="text-primary mb-1">
                                <?= $total_usuarios ?? 0 ?>
                            </h5>
                            <p class="small text-muted mb-0">Usuarios asignados</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center py-3">
                            <h5 class="text-info mb-1">
                                <?= count($permisos_agrupados, COUNT_RECURSIVE) - count($permisos_agrupados) ?>
                            </h5>
                            <p class="small text-muted mb-0">Permisos disponibles</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-light">
                        <div class="card-body text-center py-3">
                            <h5 class="text-success mb-1">
                                <?= count($permisos_ids ?? []) ?>
                            </h5>
                            <p class="small text-muted mb-0">Permisos asignados</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <?php View::partial('roles/_form') ?>
        </div>
        
        <div class="col-lg-4">
            <!-- Información del rol -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información Actual</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>ID:</th>
                            <td><code>#<?= $rol->id ?></code></td>
                        </tr>
                        <tr>
                            <th>Creado:</th>
                            <td>
                                <?= $rol->created_at ? date('d/m/Y H:i', strtotime($rol->created_at)) : 'N/A' ?>
                            </td>
                        </tr>
                        <tr>
                            <th>Actualizado:</th>
                            <td>
                                <?= $rol->updated_at ? date('d/m/Y H:i', strtotime($rol->updated_at)) : 'N/A' ?>
                            </td>
                        </tr>
                        <tr>
                            <th>Estado:</th>
                            <td>
                                <?php if ($rol->activo): ?>
                                    <span class="badge bg-success">Activo</span>
                                <?php else: ?>
                                    <span class="badge bg-danger">Inactivo</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Usuarios con este rol -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Usuarios Asignados</h6>
                </div>
                <div class="card-body">
                    <?php 
                    $usuarios_rol = (new Usuarios())->find("rol_id = $rol->id", "limit: 5");
                    if ($usuarios_rol):
                    ?>
                        <div class="list-group list-group-flush">
                            <?php foreach ($usuarios_rol as $usuario): ?>
                                <a href="<?= PUBLIC_PATH ?>admin/usuarios/ver/<?= $usuario->id ?>" 
                                   class="list-group-item list-group-item-action small py-2">
                                    <div class="d-flex justify-content-between">
                                        <span><?= h($usuario->nombre) ?></span>
                                        <?php if ($usuario->activo): ?>
                                            <span class="badge bg-success">Activo</span>
                                        <?php else: ?>
                                            <span class="badge bg-danger">Inactivo</span>
                                        <?php endif; ?>
                                    </div>
                                    <small class="text-muted"><?= h($usuario->codigo) ?></small>
                                </a>
                            <?php endforeach; ?>
                        </div>
                        <div class="text-center mt-2">
                            <a href="<?= PUBLIC_PATH ?>admin/usuarios?rol=<?= $rol->id ?>" 
                               class="btn btn-sm btn-outline-primary">
                                Ver todos los usuarios
                            </a>
                        </div>
                    <?php else: ?>
                        <p class="text-muted small">No hay usuarios asignados</p>
                    <?php endif; ?>
                </div>
            </div>
            
            <!-- Historial de cambios -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">Cambios Recientes</h6>
                </div>
                <div class="card-body">
                    <?php 
                    $cambios = LogAcceso::find([
                        "conditions" => "accion LIKE '%rol%' AND detalles LIKE '%\"rol_id\":\"$rol->id\"%'",
                        "order" => "fecha DESC",
                        "limit" => 3
                    ]);
                    
                    if ($cambios):
                    ?>
                        <div class="timeline">
                            <?php foreach ($cambios as $cambio): ?>
                                <div class="timeline-item mb-3">
                                    <small class="text-muted d-block">
                                        <?= date('d/m H:i', strtotime($cambio->fecha)) ?>
                                    </small>
                                    <span class="badge bg-info">
                                        <?= ucfirst(str_replace('_', ' ', $cambio->accion)) ?>
                                    </span>
                                    <small class="text-muted d-block">
                                        <?= $cambio->usuarios_id ? 'Usuario #' . $cambio->usuarios_id : 'Sistema' ?>
                                    </small>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    <?php else: ?>
                        <p class="text-muted small">No hay cambios registrados</p>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>